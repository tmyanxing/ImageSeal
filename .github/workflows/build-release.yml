name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: ./frontend/imageseal-ui
      run: npm ci
      
    - name: æ„å»ºå‰ç«¯
      working-directory: ./frontend/imageseal-ui
      run: npm run build
      
    - name: è¿˜åŸåç«¯ä¾èµ–
      working-directory: ./backend/ImageSeal.Api
      run: dotnet restore
      
    - name: å‘å¸ƒ Windows x64 ç‰ˆæœ¬
      working-directory: ./backend/ImageSeal.Api
      run: |
        dotnet publish -c Release -r win-x64 --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -o ../../publish/win-x64
          
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { $matches[1] } else { 'dev' }
        Compress-Archive -Path publish/win-x64/* -DestinationPath "ImageSeal-$version-win-x64.zip"
        
    - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { $matches[1] } else { 'dev' }
        $hash = (Get-FileHash "ImageSeal-$version-win-x64.zip" -Algorithm SHA256).Hash
        "$hash  ImageSeal-$version-win-x64.zip" | Out-File -FilePath "ImageSeal-$version-win-x64.zip.sha256" -Encoding UTF8
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ImageSeal-Windows
        path: |
          ImageSeal-*.zip
          ImageSeal-*.sha256
        retention-days: 90
        
    - name: åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ImageSeal-*.zip
          ImageSeal-*.sha256
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ImageSeal - å›¾ç‰‡æ°´å°å·¥å…· ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          - **Windows x64**: ImageSeal-${{ github.ref_name }}-win-x64.zip
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. åŒå‡»è¿è¡Œ `ImageSeal.exe`
          3. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:30032
          4. å¼€å§‹ä½¿ç”¨æ°´å°å·¥å…·ï¼
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          
          - ä¸Šä¼ å›¾ç‰‡å¹¶å®æ—¶é¢„è§ˆ
          - è‡ªå®šä¹‰æ°´å°æ–‡å­—ã€å­—ä½“å¤§å°ã€é¢œè‰²
          - å¯è°ƒèŠ‚é€æ˜åº¦ï¼ˆ0-100%ï¼‰
          - å¯è°ƒèŠ‚æ—‹è½¬è§’åº¦ï¼ˆæ–œå‘æ°´å°ï¼‰
          - å¯è°ƒèŠ‚æ°´å°é—´è·
          - ä¸€é”®ä¸‹è½½å¸¦æ°´å°çš„å›¾ç‰‡
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          
          ä¸‹è½½åå¯ä½¿ç”¨ SHA256 æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```powershell
          Get-FileHash ImageSeal-${{ github.ref_name }}-win-x64.zip -Algorithm SHA256
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
